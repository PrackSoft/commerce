{% extends "auctions/layout.html" %}

{% block body %}
<!-- Organizes content within semantic HTML and structured <div> blocks, supporting readability and styling. -->
<div class="listings">
    <!-- Displays key listing information including title, description, current price, and current owner, providing context for the auction. -->
    <h3>{{ listing.title }}</h3>
    <p>Seller: {{ listing.owner }}</p>
    <p>{{ listing.description }}</p>
    <p>
        {% if has_bids %}
            <p>Current price: ${{ current_price }} by {{ current_owner }}</p>
        {% else %}
            <p>Starting price: ${{ listing.starting_bid }}</p>
        {% endif %}
    </p>
    {% if listing.image_url %}  <!-- Conditionally renders the listing image only if a URL is provided, preventing broken images. -->
        <img src="{{ listing.image_url }}" alt="{{ listing.title }}">
    {% endif %}

    {% if request.user.is_authenticated and request.user == listing.owner and listing.is_active %} <!-- Allows the listing owner to close the auction when active, using a CSRF-protected form for security. -->
    <form action="{% url 'close_auction' listing.id %}" method="post">
        {% csrf_token %}
        <button type="submit">Close Auction</button>
    </form>
    {% endif %}

    {% if show_message %}
        <p style="color:green">{{ message }}</p>
    {% endif %}

    {% if request.user.is_authenticated and request.user != listing.owner and listing.is_active %}  <!-- Enables authenticated users to add or remove the listing from their watchlist, improving engagement. -->
        <form method="post" action="{% url 'toggle_watchlist' listing.id %}">
            {% csrf_token %}
            <input type="submit" value="{% if is_watching %}Remove from Watchlist{% else %}Add to Watchlist{% endif %}">
        </form>
    {% endif %}

    {% if request.user.is_authenticated and request.user != listing.owner and listing.is_active %}  <!-- Provides a form for placing bids with numeric validation and displays errors when bids are invalid. -->
        <form method="post" action="{% url 'place_bid' listing.id %}">
            {% csrf_token %}
            <input type="number" step="0.01" name="bid_amount" placeholder="Enter your bid" required>
            <input type="submit" value="Place a Bid">
        </form>
        {% if error %}
            <p style="color:red">{{ error }}</p>
        {% endif %}
    {% endif %}

    {% if request.user.is_authenticated %}  <!-- Allows authenticated users to submit comments and displays all existing comments dynamically. -->
        <form method="post" action="{% url 'add_comment' listing.id %}">
            {% csrf_token %}
            {{ form.text }}
            <input type="submit" value="Save">
        </form>
    {% endif %}
    <h3>Comments:</h3>
    {% for comment in comments %}
        <div>{{ comment.author }}: {{ comment.text }}</div>
    {% empty %} <!-- Handles empty comment lists gracefully with empty, improving user experience. -->
        <p>No comments yet.</p>
    {% endfor %}

</div>

{% endblock %}
